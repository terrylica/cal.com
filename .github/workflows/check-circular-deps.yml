name: Check Circular Dependencies
on:
  workflow_call:
permissions:
  actions: write
  contents: read
jobs:
  check-circular-deps:
    name: No circular imports
    runs-on: blacksmith-2vcpu-ubuntu-2404
    steps:
      - uses: actions/checkout@v4
        with:
          sparse-checkout: .github
      - uses: ./.github/actions/cache-checkout
      - uses: ./.github/actions/yarn-install
      - name: Check for circular dependency imports
        run: |
          npx biome lint \
            --only=style/noRestrictedImports \
            --diagnostic-level=error \
            --max-diagnostics=none \
            --reporter=github \
            --skip-parse-errors \
            ./packages/trpc \
            ./packages/lib \
            ./packages/testing
          # Clean packages only. Add more as violations are fixed:
          # ./packages/lib          (3 errors - @calcom/features imports)
          # ./packages/platform/atoms (4 errors - @calcom/trpc imports)
          # ./apps/api/v2           (6 errors - disallowed @calcom/* imports)
          # ./packages/features     (~60 errors - @calcom/trpc imports)
          # ./packages/app-store    (~100+ errors - @calcom/features imports)
